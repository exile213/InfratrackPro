{% extends 'base.html' %} {% block title %}Infratrack - Report Page {%endblock%}
{% block extra_css %}
<!-- Leaflet CSS for map -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
{% endblock %} {% block extra_js %}
<!-- Leaflet JS for map (optional, for real map functionality) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  var map;
  var marker;
  // Example: Initialize the map if you want it to be interactive
  document.addEventListener("DOMContentLoaded", function () {
    if (window.L && document.getElementById("report-map")) {
      map = L.map("report-map").setView([10.67, 122.95], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "Â© OpenStreetMap",
      }).addTo(map);
      map.on("click", function (e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        if (marker) {
          map.removeLayer(marker);
        }
        marker = L.marker([lat, lng]).addTo(map);
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
        fetch(
          `/reverse-geocode/?lat=${lat}&lon=${lng}` // Updated URL to your Django backend
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            if (data.error) {
              console.error("Error from backend:", data.error);
              document.getElementById("address-display").textContent =
                "Could not fetch address.";
              return;
            }
            // Adjusting to the structure returned by your Django view using geopy
            const address = data.address;
            const road = address.road || "";
            const city =
              address.city || address.town || address.municipality || "";
            const barangay =
              address.suburb || address.village || address.hamlet || "";
            const province =
              address.state || address.county || address.state_district || "";
            const fullAddress = data.display_name;

            document.getElementById("city").value = city;
            document.getElementById("barangay").value = barangay;
            document.getElementById("street").value = street;
            document.getElementById("province").value = province;
            document.getElementById("display-street").innerText = data.address.road || data.address.street || "";
            document.getElementById("display-barangay").innerText =
              data.address.village ||
              data.address.suburb ||
              data.address.hamlet ||
              "";
            document.getElementById("display-city").innerText =
              data.address.city ||
              data.address.town ||
              data.address.municipality ||
              data.address.city_district ||
              "";
            document.getElementById("display-province").innerText =
              data.address.state ||
              data.address.county ||
              data.address.state_district ||
              "";
          })
          .catch((error) => {
            console.error("Fetch error:", error);
            document.getElementById("address-display").textContent =
              "Error fetching address details.";
          });
      });
    }
  });

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          if (marker) {
            map.removeLayer(marker);
          }
          map.setView([lat, lng], 16); // Set map view to current location with zoom
          if (marker) {
            map.removeLayer(marker);
          }
          marker = L.marker([lat, lng]).addTo(map);
          document.getElementById("latitude").value = lat;
          document.getElementById("longitude").value = lng;
          fetch(`/reverse-geocode/?lat=${lat}&lon=${lng}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              if (data.error) {
                console.error("Error from backend:", data.error);
                document.getElementById("address-display").textContent =
                  "Could not fetch address.";
                return;
              }
              const address = data.address;
              const road = address.road || "";
              const city =
                address.city || address.town || address.municipality || "";
              const barangay =
                address.suburb || address.village || address.hamlet || "";
              const province =
                address.state || address.county || address.state_district || "";

              document.getElementById("city").value = city;
              document.getElementById("barangay").value = barangay;
              document.getElementById("street").value = street;
              document.getElementById("province").value = province;
              document.getElementById("display-street").innerText = data.address.road || data.address.street || "";
              document.getElementById("display-barangay").innerText =
                data.address.village ||
                data.address.suburb ||
                data.address.hamlet ||
                "";
              document.getElementById("display-city").innerText =
                data.address.city ||
                data.address.town ||
                data.address.municipality ||
                data.address.city_district ||
                "";
              document.getElementById("display-province").innerText =
                data.address.state ||
                data.address.county ||
                data.address.state_district ||
                "";
            })
            .catch((error) => {
              console.error("Fetch error:", error);
              document.getElementById("address-display").textContent =
                "Error fetching address details.";
            });
        },
        (error) => {
          console.error("Geolocation error:", error);
          alert("Unable to retrieve your location.");
        }
      );
    } else {
      alert("Geolocation is not supported by your browser.");
    }
  }

  function searchLocation() {
    const query = document.getElementById("location").value;
    if (query) {
      fetch(`/geocode/?query=${encodeURIComponent(query)}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          if (data.error) {
            console.error("Error from backend:", data.error);
            alert("Could not find location.");
            return;
          }
          const lat = data.latitude;
          const lng = data.longitude;
          if (marker) {
            map.removeLayer(marker);
          }
          map.setView([lat, lng], 12); // Center map on searched location
          document.getElementById("latitude").value = lat;
          document.getElementById("longitude").value = lng;

          const address = data.address;
          const street = address.road || address.street || "";
          const city =
            address.city ||
            address.town ||
            address.municipality ||
            address.village ||
            address.suburb ||
            address.hamlet ||
            "";
          const barangay =
            address.suburb || address.village || address.hamlet || "";
          const province =
            address.state ||
            address.county ||
            address.state_district ||
            address.region ||
            "";

          document.getElementById("city").value = city;
          document.getElementById("barangay").value = barangay;
          document.getElementById("street").value = street;
          document.getElementById("province").value = province;
          document.getElementById("display-street").innerText = data.address.road || data.address.street || "";
          document.getElementById("display-barangay").innerText =
            data.address.village ||
            data.address.suburb ||
            data.address.hamlet ||
            "";
          document.getElementById("display-city").innerText =
            data.address.city ||
            data.address.town ||
            data.address.municipality ||
            data.address.city_district ||
            "";
          document.getElementById("display-province").innerText =
            data.address.state ||
            data.address.county ||
            data.address.state_district ||
            "";
        })
        .catch((error) => {
          console.error("Fetch error:", error);
          alert("Error searching for location.");
        });
    } else {
      alert("Please enter a location to search.");
    }
  }
</script>
{% endblock %} {% block content %}
<!-- Hero Section -->
<div class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 py-16">
  <div class="w-full max-w-4xl mx-auto text-center px-4">
    <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-white mb-4">
      Report Infrastructures
    </h1>
    <p class="text-indigo-100 text-lg mb-8">
      Help improve our communities by reporting damaged roads, drainage,
      streetlights, and other public infrastructure.
    </p>
    <a
      href="#report-form"
      class="inline-block bg-white text-indigo-600 font-semibold px-8 py-4 rounded-lg shadow-lg hover:bg-indigo-50 transition-all duration-200 text-lg"
      >Start Your Report</a
    >
  </div>
</div>

<!-- Card Form Section -->
<div class="w-full bg-gradient-to-br from-slate-50 to-gray-100 py-16">
  <div class="w-full max-w-4xl mx-auto px-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 sm:p-10">
      <h2 class="text-xl font-semibold mb-4">Submit Infrastructure Report</h2>
      <form id="report-form" class="space-y-6">
        <!-- File Upload -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
          <label class="block text-lg font-semibold text-gray-800 mb-3"
            >Upload Photo of Damage</label
          >
          <div
            class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-xl py-10 cursor-pointer hover:border-indigo-400 transition-all duration-300 group"
          >
            <svg
              class="w-12 h-12 text-indigo-500 mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16V4a1 1 0 011-1h8a1 1 0 011 1v12m-4 4h-4a1 1 0 01-1-1v-4h10v4a1 1 0 01-1 1h-4z"
              />
            </svg>
            <span class="text-gray-600 text-lg font-medium"
              >Click to upload or drag and drop</span
            >
            <input type="file" accept="image/png, image/jpeg" class="hidden" />
            <span class="text-sm text-gray-500 mt-2">PNG, JPG up to 10MB</span>
          </div>
        </div>
        <!-- Issue Type -->
        <div class="bg-gray-50 py-2 px-6 rounded-xl border border-gray-200">
          <label class="block text-lg font-semibold text-gray-800 mb-3"
            >Type of Infrastructure Issue</label
          >
          <select class="block w-full input-modern" required>
            <option selected disabled>Select issue type...</option>
            <option>Pothole</option>
            <option>Drainage</option>
            <option>Streetlight</option>
            <option>Other</option>
          </select>
        </div>
        <!-- Location -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
          <label class="block text-lg font-semibold text-gray-800 mb-3"
            >Location</label
          >
          <div class="flex flex-col sm:flex-row gap-3 mb-4">
            <button
              type="button"
              onclick="getLocation()"
              class="inline-flex items-center px-4 py-2 rounded-xl font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition duration-150 ease-in-out shadow mr-2"
            >
              Use My Location
            </button>
            <input
              id="location"
              name="location"
              type="text"
              required
              class="mt-1 block w-full px-5 py-3 border-2 border-indigo-300 rounded-2xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-500 sm:text-base"
              placeholder="Enter location (e.g., Main Street, City)"
              onkeydown="if(event.keyCode === 13) { event.preventDefault(); searchLocation(); }"
            />
          </div>
          <div
            class="h-64 rounded-xl overflow-hidden border border-gray-300 shadow-inner"
          >
            <!-- Map container -->
            <div id="report-map" class="w-full h-full"></div>
          </div>
          <!-- Hidden Location Inputs and Address Display -->
          <input type="hidden" name="latitude" id="latitude" />
          <input type="hidden" name="longitude" id="longitude" />
          <input type="hidden" name="city" id="city" />
          <input type="hidden" name="barangay" id="barangay" />
          <input type="hidden" name="street" id="street" />
          <input type="hidden" name="province" id="province" />
          <div id="address-display" class="mt-2 text-sm text-gray-700">
            <p>
              <span class="font-semibold">Street:</span>
              <span id="display-street"></span>
            </p>
            <p>
              <span class="font-semibold">Barangay:</span>
              <span id="display-barangay"></span>
            </p>
            <p>
              <span class="font-semibold">City:</span>
              <span id="display-city"></span>
            </p>
            <p>
              <span class="font-semibold">Province:</span>
              <span id="display-province"></span>
            </p>
          </div>
        </div>
        <!-- Description -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
          <label class="block text-lg font-semibold text-gray-800 mb-3"
            >Description</label
          >
          <textarea
            class="block w-full input-modern bg-white"
            rows="4"
            placeholder="Please describe the issue in detail..."
          ></textarea>
        </div>
        <!-- Contact Info Notice -->
        <div
          class="bg-indigo-50 border border-indigo-200 text-indigo-800 rounded-xl p-5 text-base font-medium"
        >
          <span class="font-bold">Contact Information Required:</span><br />
          To ensure authentic reports and enable follow-up communication, we
          require your contact details. Your information will be kept
          confidential.
        </div>
        <!-- Contact Fields -->
        <div class="flex flex-col md:flex-row gap-4">
          <input
            type="text"
            class="flex-1 p-3 input-modern bg-white border border-gray-300"
            placeholder="Your Full Name"
          />
          <input
            type="email"
            class="flex-1 p-3 input-modern bg-white border border-gray-300"
            placeholder="your.email@example.com"
          />
        </div>
        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 justify-end pt-4">
          <button
            type="reset"
            class="w-full py-3 px-4 rounded-xl font-semibold text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 transition duration-150 ease-in-out shadow"
          >
            Clear Form
          </button>
          <button
            type="submit"
            class="w-full py-3 px-4 rounded-xl font-semibold text-white bg-gradient-to-r from-indigo-600 to-pink-500 hover:from-indigo-700 hover:to-pink-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out shadow"
          >
            Submit Report
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

<div class="mb-4">
  <label for="full_name" class="block text-sm font-medium text-gray-700 mb-1"
    >Full Name</label
  >
  <input
    id="full_name"
    name="full_name"
    type="text"
    required
    class="mt-1 block w-full px-5 py-3 border-2 border-indigo-300 rounded-2xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-500 sm:text-base"
    placeholder="Enter your full name"
  />
</div>
<div class="mb-4">
  <label for="email" class="block text-sm font-medium text-gray-700 mb-1"
    >Email</label
  >
  <input
    id="email"
    name="email"
    type="email"
    required
    class="mt-1 block w-full px-5 py-3 border-2 border-indigo-300 rounded-2xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-500 sm:text-base"
    placeholder="Enter your email address"
  />
</div>
<div class="mb-4">
  <label for="description" class="block text-sm font-medium text-gray-700 mb-1"
    >Description</label
  >
  <textarea
    id="description"
    name="description"
    required
    rows="4"
    class="mt-1 block w-full px-5 py-3 border-2 border-indigo-300 rounded-2xl shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-500 sm:text-base"
    placeholder="Please describe the issue in detail..."
  ></textarea>
</div>
