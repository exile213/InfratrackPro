<!-- Search Bar Row -->
<div class="bg-gradient-to-r from-indigo-50 to-white rounded-2xl shadow border border-indigo-200 p-6 mb-4">
    <form id="search-form" class="flex flex-col md:flex-row md:items-end gap-4">
        <div class="flex-1">
            <label class="block text-gray-800 text-base font-semibold mb-2">Search Submitter</label>
            <input type="text" id="search-submitter" placeholder="Citizen name or ID"
                class="w-full px-5 py-3 border-2 border-indigo-400 bg-white rounded-xl shadow focus:ring-2 focus:ring-indigo-500 focus:border-indigo-600 text-gray-900 placeholder-gray-400 text-base transition-all duration-200" />
        </div>
        <button type="submit"
            class="inline-flex items-center justify-center px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg border-2 border-indigo-700 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-400 w-full md:w-auto text-base">Search</button>
    </form>
</div>
<!-- Filter Section -->
<div class="bg-white rounded-2xl shadow border border-indigo-100 p-6 mb-6">
    <form id="filter-form" class="grid gap-4 md:grid-cols-3">
        <div>
            <label class="block text-gray-800 text-base font-semibold mb-2">Start Date</label>
            <input type="date" id="filter-start"
                class="w-full px-5 py-3 border-2 border-indigo-300 bg-gray-50 rounded-xl shadow focus:ring-2 focus:ring-indigo-400 focus:border-indigo-600 text-gray-900 placeholder-gray-400 text-base transition-all duration-200" />
        </div>
        <div>
            <label class="block text-gray-800 text-base font-semibold mb-2">End Date</label>
            <input type="date" id="filter-end"
                class="w-full px-5 py-3 border-2 border-indigo-300 bg-gray-50 rounded-xl shadow focus:ring-2 focus:ring-indigo-400 focus:border-indigo-600 text-gray-900 placeholder-gray-400 text-base transition-all duration-200" />
        </div>
        <div>
            <label class="block text-gray-800 text-base font-semibold mb-2">Issue Type</label>
            <select id="filter-issue-type"
                class="w-full px-5 py-3 border-2 border-indigo-300 bg-gray-50 rounded-xl shadow focus:ring-2 focus:ring-indigo-400 focus:border-indigo-600 text-gray-900 text-base transition-all duration-200">
                <option>All Types</option>
                <option>Pothole</option>
                <option>Flooding</option>
                <option>Streetlight</option>
            </select>
        </div>
        <div>
            <label class="block text-gray-800 text-base font-semibold mb-2">Location</label>
            <select id="filter-location"
                class="w-full px-5 py-3 border-2 border-indigo-300 bg-gray-50 rounded-xl shadow focus:ring-2 focus:ring-indigo-400 focus:border-indigo-600 text-gray-900 text-base transition-all duration-200">
                <option>All Locations</option>
                <option>District 1</option>
                <option>District 2</option>
                <option>District 3</option>
            </select>
        </div>
        <div class="md:col-span-3 flex justify-end">
            <button type="submit"
                class="inline-flex items-center justify-center px-8 py-3 bg-white hover:bg-indigo-600 hover:text-white text-indigo-700 font-bold rounded-xl border-2 border-indigo-600 shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-base">Apply
                Filters</button>
        </div>
    </form>
</div>
<!-- Chart Card -->
<div class="bg-white rounded-2xl shadow-md p-6 mb-6 dark:bg-gray-900">
    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Issue Reports Over Time</h2>
    <div
        class="h-80 w-full flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
        <canvas id="chart-time" class="w-full h-full !important"
            style="width:100% !important; height:100% !important;"></canvas>
    </div>
</div>
<script>
    let chartTimeInstance = null;

    function fetchAndRenderAnalytics() {
        const start = document.getElementById('filter-start').value;
        const end = document.getElementById('filter-end').value;
        const issueType = document.getElementById('filter-issue-type').value;
        // Build query string
        let url = `/api/analytics/reports-over-time/?`;
        if (start) url += `start=${start}&`;
        if (end) url += `end=${end}&`;
        if (issueType && issueType !== 'All Types') url += `issue_type=${encodeURIComponent(issueType)}&`;
        fetch(url)
            .then(res => res.json())
            .then(data => {
                // Prepare chart data
                const allDates = new Set();
                Object.values(data).forEach(typeData => {
                    Object.keys(typeData).forEach(date => allDates.add(date));
                });
                const sortedDates = Array.from(allDates).sort();
                const datasets = Object.keys(data).map((type, idx) => {
                    const colorList = ['#6366F1', '#10B981', '#F59E42', '#EF4444', '#3B82F6'];
                    return {
                        label: type,
                        data: sortedDates.map(date => data[type][date] || 0),
                        borderColor: colorList[idx % colorList.length],
                        backgroundColor: colorList[idx % colorList.length] + '33',
                        tension: 0.4,
                        fill: true
                    };
                });
                // Update Chart.js
                const ctx = document.getElementById('chart-time').getContext('2d');
                if (chartTimeInstance) chartTimeInstance.destroy();
                chartTimeInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#fff' : '#1e293b'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#fff' : '#1e293b'
                                },
                                grid: {
                                    color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#334155' : '#e5e7eb'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#fff' : '#1e293b'
                                },
                                grid: {
                                    color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#334155' : '#e5e7eb'
                                }
                            }
                        }
                    }
                });
                // Update Table
                const tableBody = document.getElementById('analytics-time-table-body');
                tableBody.innerHTML = '';
                sortedDates.forEach(date => {
                    let total = 0;
                    let typeCounts = {};
                    let uniqueSubmitters = new Set();
                    Object.keys(data).forEach(type => {
                        const count = data[type][date] || 0;
                        total += count;
                        typeCounts[type] = count;
                        // For demo, unique submitters is random (replace with real logic if you have submitter info)
                    });
                    // Find most common issue type
                    let mostCommonType = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || '-';
                    tableBody.innerHTML += `<tr>
                    <td class="px-4 py-2">${date}</td>
                    <td class="px-4 py-2">${total}</td>
                    <td class="px-4 py-2">${mostCommonType}</td>
                    <td class="px-4 py-2">-</td>
                </tr>`;
                });
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        fetchAndRenderAnalytics();
        document.getElementById('filter-form').addEventListener('submit', function (e) {
            e.preventDefault();
            fetchAndRenderAnalytics();
        });
    });
</script>
<!-- Secondary Tabs -->
<div x-data="{ subtab: 'table' }" class="bg-white rounded-2xl shadow-md p-6 dark:bg-gray-900">
    <div class="flex space-x-2 mb-4">
        <button @click="subtab = 'table'"
            :class="subtab === 'table' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'"
            class="px-3 py-1 rounded-lg font-medium focus:outline-none transition">Summary Table</button>
        <button @click="subtab = 'insights'"
            :class="subtab === 'insights' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'"
            class="px-3 py-1 rounded-lg font-medium focus:outline-none transition">Insights</button>
    </div>
    <div>
        <div x-show="subtab === 'table'">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-800">
                        <tr>
                            <th
                                class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Date</th>
                            <th
                                class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Total Issues</th>
                            <th
                                class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Most Common Issue Type</th>
                            <th
                                class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Unique Submitters</th>
                        </tr>
                    </thead>
                    <tbody id="analytics-time-table-body"
                        class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-800">
                        <!-- JS will populate rows here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div x-show="subtab === 'insights'">
            <ul class="list-disc pl-6 text-gray-700 dark:text-gray-200">
                <li>Pothole reports increased by 30% in March 2025.</li>
                <li>Resolution rate improved compared to February.</li>
                <li>Most reports submitted on Mondays.</li>
            </ul>
        </div>
    </div>
</div>